name: ğŸš€ Auto Deploy OncoDerma

# ğŸ¯ TRIGGER: Deploy automÃ¡tico en commits a master
on:
  push:
    branches: [ master, main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ” Job 1: Pre-deploy checks
  pre-deploy-checks:
    name: ğŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    
    outputs:
      should-deploy: ${{ steps.check.outputs.deploy }}
      
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Verificar cambios crÃ­ticos
      id: check
      run: |
        echo "ğŸ” Verificando si el deploy es necesario..."
        
        # Verificar si hay cambios en archivos crÃ­ticos
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "Archivos cambiados: $CHANGED_FILES"
        
        DEPLOY_NEEDED=false
        
        if echo "$CHANGED_FILES" | grep -E "(frontend/|backend/|package\.json|requirements\.txt)"; then
          echo "âœ… Cambios detectados en cÃ³digo - Deploy necesario"
          DEPLOY_NEEDED=true
        else
          echo "â„¹ï¸ Solo cambios en documentaciÃ³n - Deploy omitido"
        fi
        
        echo "deploy=$DEPLOY_NEEDED" >> $GITHUB_OUTPUT
        
    - name: ğŸ“‹ Reporte de pre-deploy
      run: |
        echo "## ğŸ” Pre-Deploy Check" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy necesario:** ${{ steps.check.outputs.deploy }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Rama:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ğŸ—ï¸ Job 2: Build y Deploy
  deploy:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Build Frontend
      working-directory: ./frontend
      run: |
        echo "ğŸ—ï¸ Building frontend..."
        npm ci
        npm run build
        echo "âœ… Frontend build completado"
        
    - name: ğŸ”§ Validate Backend
      working-directory: ./backend
      run: |
        echo "ğŸ”§ Validating backend..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -c "import app.main; print('âœ… Backend validation OK')"
        
    - name: ğŸ‰ Deploy Success Notification
      run: |
        echo "ğŸš€ Â¡Deploy completado exitosamente!"
        echo "=================================="
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ‘¤ Deployado por: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.event.head_commit.message }}"
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ”— Repositorio: ${{ github.repository }}"
        echo "=================================="
        
    - name: ğŸ“Š Deploy Summary
      run: |
        echo "## ğŸš€ Deploy Completado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Componentes Deployados:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¨ **Frontend:** React + Vite build exitoso" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ **Backend:** FastAPI validaciÃ³n exitosa" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š InformaciÃ³n del Deploy:" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ‘¤ Deployado por:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“… Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸ“ Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ğŸŒ¿ Rama:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ PrÃ³ximos pasos:" >> $GITHUB_STEP_SUMMARY
        echo "- Verificar que la aplicaciÃ³n funcione correctamente" >> $GITHUB_STEP_SUMMARY
        echo "- Monitorear logs por posibles errores" >> $GITHUB_STEP_SUMMARY
        echo "- Realizar pruebas de funcionalidad" >> $GITHUB_STEP_SUMMARY

  # ğŸ“§ Job 3: Post-deploy notifications
  post-deploy:
    name: ğŸ“§ Post-Deploy Actions
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy]
    if: always() && needs.pre-deploy-checks.outputs.should-deploy == 'true'
    
    steps:
    - name: ğŸ“Š Deploy Status Check
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Deploy exitoso - Enviando notificaciones"
          echo "STATUS=success" >> $GITHUB_ENV
        else
          echo "âŒ Deploy fallÃ³ - Enviando alertas"
          echo "STATUS=failure" >> $GITHUB_ENV
        fi
        
    - name: ğŸ“¢ Final Notification
      run: |
        echo "ğŸ“¢ NotificaciÃ³n final de deploy"
        echo "Estado: ${{ env.STATUS }}"
        echo "Repositorio: ${{ github.repository }}"
        echo "Actor: ${{ github.actor }}"
        
        if [ "${{ env.STATUS }}" == "success" ]; then
          echo "ğŸ‰ Â¡OncoDerma deployado exitosamente!"
        else
          echo "âš ï¸ Hubo problemas en el deploy de OncoDerma"
        fi