name: ğŸš€ OncoDerma CI/CD Pipeline

# ğŸ¯ TRIGGER: Se ejecuta en cada commit
on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

# ğŸ”§ Variables de entorno
env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ“‹ Job 1: AnÃ¡lisis y Testing del Frontend
  frontend-tests:
    name: ğŸ¨ Frontend Tests & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Instalar dependencias Frontend
      working-directory: ./frontend
      run: |
        npm ci
        
    - name: ğŸ” Lint Frontend
      working-directory: ./frontend
      run: |
        npm run lint
        
    - name: ğŸ—ï¸ Build Frontend
      working-directory: ./frontend
      run: |
        npm run build
        
    - name: ğŸ“¤ Upload Frontend Build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  # ğŸ Job 2: Testing del Backend
  backend-tests:
    name: ğŸ”§ Backend Tests & Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Instalar dependencias Backend
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” Lint Backend (flake8)
      working-directory: ./backend
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: âœ… Validar sintaxis Python
      working-directory: ./backend
      run: |
        python -m py_compile app/main.py
        python -c "import app.main; print('âœ… Backend syntax OK')"

  # ğŸš€ Job 3: Deploy Notification
  deploy-notification:
    name: ğŸ“¢ Deploy Notification
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generar reporte de deploy
      run: |
        echo "ğŸ‰ Deploy exitoso para OncoDerma!"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ’¬ Mensaje: ${{ github.event.head_commit.message }}"
        
    - name: ğŸ“‹ Crear summary
      run: |
        echo "## ğŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“… Fecha | $(date) |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ‘¤ Usuario | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ¿ Rama | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ’¬ Mensaje | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Jobs Completados:" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¨ Frontend: Build y tests" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ Backend: ValidaciÃ³n y lint" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¢ NotificaciÃ³n: Deploy exitoso" >> $GITHUB_STEP_SUMMARY

  # ğŸ”„ Job 4: Auto-update dependencies (solo los lunes)
  dependency-update:
    name: ğŸ”„ Dependency Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[deps]'))
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ğŸ” Check outdated packages
      working-directory: ./frontend
      run: |
        npm outdated || true
        echo "ğŸ“‹ Dependency check completed"

# ğŸ“… Trigger adicional: Ejecutar dependency check los lunes
on:
  schedule:
    - cron: '0 9 * * 1'  # Lunes a las 9 AM UTC